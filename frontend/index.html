<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOTO Store Finder</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .stats {
            background: white;
            padding: 15px 20px;
            display: flex;
            gap: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            background: #66bb6a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .stat-info h3 {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .stat-info p {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        #map {
            height: calc(100vh - 180px);
            width: 100%;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.2);
        }

        .popup-content {
            min-width: 250px;
        }

        .popup-header {
            font-size: 16px;
            font-weight: 600;
            color: #43a047;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #66bb6a;
        }

        .popup-section {
            margin: 10px 0;
        }

        .popup-section strong {
            display: block;
            color: #666;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .popup-section p {
            color: #333;
            font-size: 14px;
            line-height: 1.5;
        }

        .popup-hours {
            background: #f5f5f5;
            padding: 8px;
            border-radius: 6px;
            margin-top: 5px;
        }

        .popup-hours-item {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            padding: 3px 0;
        }

        .popup-hours-day {
            color: #666;
        }

        .popup-hours-time {
            color: #333;
            font-weight: 500;
        }

        .popup-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background: #66bb6a;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 13px;
            transition: background 0.2s;
        }

        .popup-link:hover {
            background: #43a047;
        }

        .services-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .service-tag {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        .locate-button {
            position: absolute;
            top: 80px;
            right: 10px;
            z-index: 1000;
            background: white;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            width: 34px;
            height: 34px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            transition: background 0.3s;
        }

        .locate-button:hover {
            background: #f4f4f4;
        }

        .locate-button:active {
            background: #e0e0e0;
        }

        .locate-button.loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .error-message {
            position: absolute;
            top: 120px;
            right: 10px;
            z-index: 1000;
            background: #f44336;
            color: white;
            padding: 12px 16px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            max-width: 300px;
            font-size: 13px;
            line-height: 1.4;
        }

        .error-message button {
            background: white;
            color: #f44336;
            border: none;
            padding: 4px 8px;
            margin-top: 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå± SOTO Produkte finden </h1>
        <p>Finde SOTO Produkte in deiner N√§he</p>
    </div>

    <div class="stats">
        <div class="stat">
            <div class="stat-icon">üè™</div>
            <div class="stat-info">
                <h3 id="store-count">-</h3>
                <p>Filialen</p>
            </div>
        </div>
        <div class="stat">
            <div class="stat-icon">üìç</div>
            <div class="stat-info">
                <h3 id="city-count">-</h3>
                <p>St√§dte</p>
            </div>
        </div>
    </div>

    <div id="map"></div>
    <button class="locate-button" id="locateBtn" title="Mein Standort">üìç</button>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <!-- Leaflet MarkerCluster JavaScript -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        // Initialize map centered on Germany
        const map = L.map('map').setView([51.1657, 10.4515], 6);

        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // Custom icons for each chain
        const dennsIcon = L.icon({
            iconUrl: 'images/denns-marker.svg',
            iconSize: [40, 50],
            iconAnchor: [20, 50],
            popupAnchor: [0, -50]
        });

        const alnaturaIcon = L.icon({
            iconUrl: 'images/alnatura-marker.svg',
            iconSize: [40, 50],
            iconAnchor: [20, 50],
            popupAnchor: [0, -50]
        });

        const tegutIcon = L.icon({
            iconUrl: 'images/tegut-marker.svg',
            iconSize: [40, 50],
            iconAnchor: [20, 50],
            popupAnchor: [0, -50]
        });

        // Function to get icon based on chain
        function getChainIcon(chainId) {
            switch(chainId) {
                case 'denns':
                    return dennsIcon;
                case 'alnatura':
                    return alnaturaIcon;
                case 'tegut':
                    return tegutIcon;
                default:
                    return dennsIcon; // fallback
            }
        }

        // Create marker cluster group
        const markers = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true
        });

        // Load and display GeoJSON data
        fetch('stores.geojson')
            .then(response => response.json())
            .then(data => {
                const cities = new Set();

                data.features.forEach(feature => {
                    const props = feature.properties;
                    cities.add(props.city);

                    // Create popup content
                    let popupContent = `
                        <div class="popup-content">
                            <div class="popup-header">${props.name}</div>

                            <div class="popup-section">
                                <strong>üìç Adresse</strong>
                                <p>${props.address}</p>
                            </div>
                    `;

                    // Opening hours
                    if (props.opening_hours) {
                        // Check if it's text format (Alnatura) or structured (denn's)
                        if (props.opening_hours.text) {
                            // Simple text format
                            popupContent += `
                                <div class="popup-section">
                                    <strong>üïê √ñffnungszeiten</strong>
                                    <p>${props.opening_hours.text}</p>
                                </div>
                            `;
                        } else {
                            // Structured format (denn's)
                            const days = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
                            const today = days[new Date().getDay() === 0 ? 6 : new Date().getDay() - 1];

                            let hoursHtml = '<div class="popup-section"><strong>üïê √ñffnungszeiten</strong><div class="popup-hours">';

                            days.forEach(day => {
                                if (props.opening_hours[day]) {
                                    const hours = props.opening_hours[day];
                                    const isTodayClass = day === today ? 'style="font-weight: 700;"' : '';
                                    hoursHtml += `
                                        <div class="popup-hours-item" ${isTodayClass}>
                                            <span class="popup-hours-day">${day}</span>
                                        <span class="popup-hours-time">${hours.open_from} - ${hours.open_until}</span>
                                    </div>
                                `;
                            }
                            });

                            hoursHtml += '</div></div>';
                            popupContent += hoursHtml;
                        }
                    }

                    if (props.services && props.services.length > 0) {
                        popupContent += `
                            <div class="popup-section">
                                <strong>‚ú® Services</strong>
                                <div class="services-tags">
                                    ${props.services.slice(0, 6).map(s => `<span class="service-tag">${s}</span>`).join('')}
                                </div>
                            </div>
                        `;
                    }

                    if (props.website) {
                        popupContent += `
                            <a href="${props.website}" target="_blank" class="popup-link">
                                üìç Route planen
                            </a>
                        `;
                    }

                    popupContent += '</div>';

                    // Create marker with chain-specific icon
                    const chainIcon = getChainIcon(props.chain_id);
                    const marker = L.marker(
                        [feature.geometry.coordinates[1], feature.geometry.coordinates[0]],
                        { icon: chainIcon }
                    ).bindPopup(popupContent);

                    markers.addLayer(marker);
                });

                // Add markers to map
                map.addLayer(markers);

                // Update statistics
                document.getElementById('store-count').textContent = data.features.length;
                document.getElementById('city-count').textContent = cities.size;

                // Fit bounds to show all markers initially
                if (data.features.length > 0) {
                    map.fitBounds(markers.getBounds(), { padding: [50, 50] });
                }

                // Automatically try to locate user after map is loaded
                if (navigator.geolocation) {
                    map.locate({
                        setView: false,
                        maxZoom: 13,
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                }
            })
            .catch(error => {
                console.error('Error loading stores:', error);
            });

        // User location marker
        let userMarker = null;

        // Handle location found
        function onLocationFound(e) {
            const radius = e.accuracy;

            // Remove loading state
            const locateBtn = document.getElementById('locateBtn');
            locateBtn.classList.remove('loading');

            // Remove old marker if exists
            if (userMarker) {
                map.removeLayer(userMarker);
            }

            // Add user position marker
            userMarker = L.marker(e.latlng, {
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjNDA3MEYwIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSI4IiBmaWxsPSIjNDA3MEYwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjMiLz48L3N2Zz4=',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                })
            }).addTo(map);

            // Zoom to user location with appropriate zoom level
            map.setView(e.latlng, 13);
        }

        // Handle location error
        function onLocationError(e) {
            const locateBtn = document.getElementById('locateBtn');
            locateBtn.classList.remove('loading');

            // Remove any existing error messages
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }

            // Create error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';

            let errorMsg = 'Standortbestimmung fehlgeschlagen. ';
            let solution = '';

            if (e.code === 1) {
                errorMsg = 'Zugriff auf Standort verweigert. ';
                solution = 'Bitte erlaube Standortzugriff in deinen Browser-Einstellungen.';
            } else if (e.code === 2) {
                errorMsg = 'Standort nicht verf√ºgbar. ';
                solution = 'M√∂glicherweise verwendest du HTTP statt HTTPS. F√ºr lokale Entwicklung sollte "localhost" funktionieren.';
            } else if (e.code === 3) {
                errorMsg = 'Zeit√ºberschreitung. ';
                solution = 'Bitte versuche es erneut.';
            }

            errorDiv.innerHTML = `
                <strong>${errorMsg}</strong><br>
                ${solution}
                <button onclick="this.parentElement.remove()">OK</button>
            `;

            document.body.appendChild(errorDiv);

            // Auto-remove after 8 seconds
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 8000);

            console.error('Geolocation error:', e);
        }

        // Add event listeners
        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);

        // Locate button click handler
        document.getElementById('locateBtn').addEventListener('click', function() {
            const locateBtn = this;

            // Check if geolocation is available
            if (!navigator.geolocation) {
                alert('Geolocation wird von deinem Browser nicht unterst√ºtzt.');
                return;
            }

            // Add loading state
            locateBtn.classList.add('loading');

            // Remove any existing error messages
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }

            // Try to locate with timeout
            map.locate({
                setView: false,
                maxZoom: 13,
                enableHighAccuracy: true,
                timeout: 10000, // 10 seconds timeout
                maximumAge: 0 // Don't use cached position
            });

            // Remove loading state after success (handled in onLocationFound)
            setTimeout(() => {
                locateBtn.classList.remove('loading');
            }, 10000);
        });
    </script>
</body>
</html>
